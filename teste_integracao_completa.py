#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
üß™ TESTE DE INTEGRA√á√ÉO COMPLETA
===============================

Script para testar e validar toda a integra√ß√£o do sistema de gest√£o escolar.
Verifica se todos os componentes est√£o funcionando de forma integrada.

Autor: Sistema de Gest√£o Escolar
Vers√£o: 1.0 - Teste Completo
"""

import sys
import os
import traceback
from datetime import datetime, date, timedelta
from typing import Dict, List, Optional, Any

# Adicionar o diret√≥rio atual ao path
current_dir = os.path.dirname(os.path.abspath(__file__))
if current_dir not in sys.path:
    sys.path.append(current_dir)

# ==========================================================
# üîß FUN√á√ïES DE TESTE
# ==========================================================

def testar_imports():
    """Testa se todos os imports necess√°rios est√£o funcionando"""
    
    print("üîç Testando imports...")
    
    testes = {}
    
    # Teste 1: Streamlit
    try:
        import streamlit as st
        testes["streamlit"] = {"status": "‚úÖ", "erro": None}
    except Exception as e:
        testes["streamlit"] = {"status": "‚ùå", "erro": str(e)}
    
    # Teste 2: Pandas
    try:
        import pandas as pd
        testes["pandas"] = {"status": "‚úÖ", "erro": None}
    except Exception as e:
        testes["pandas"] = {"status": "‚ùå", "erro": str(e)}
    
    # Teste 3: Models Base
    try:
        from models.base import supabase, formatar_data_br, formatar_valor_br
        testes["models_base"] = {"status": "‚úÖ", "erro": None}
    except Exception as e:
        testes["models_base"] = {"status": "‚ùå", "erro": str(e)}
    
    # Teste 4: Models Pedag√≥gico
    try:
        from models.pedagogico import listar_turmas_disponiveis, buscar_alunos_para_dropdown
        testes["models_pedagogico"] = {"status": "‚úÖ", "erro": None}
    except Exception as e:
        testes["models_pedagogico"] = {"status": "‚ùå", "erro": str(e)}
    
    # Teste 5: Gest√£o de Mensalidades
    try:
        from gestao_mensalidades import (
            inicializar_sistema_mensalidades,
            gerar_mensalidades_aluno_avancado,
            listar_mensalidades_por_status
        )
        testes["gestao_mensalidades"] = {"status": "‚úÖ", "erro": None}
    except Exception as e:
        testes["gestao_mensalidades"] = {"status": "‚ùå", "erro": str(e)}
    
    return testes

def testar_conexao_database():
    """Testa a conex√£o com o banco de dados"""
    
    print("üóÑÔ∏è Testando conex√£o com base de dados...")
    
    try:
        from models.base import supabase
        
        # Teste b√°sico de conex√£o
        response = supabase.table("alunos").select("count", count="exact").execute()
        
        return {
            "status": "‚úÖ",
            "total_alunos": response.count,
            "erro": None
        }
        
    except Exception as e:
        return {
            "status": "‚ùå",
            "total_alunos": 0,
            "erro": str(e)
        }

def testar_funcionalidades_pedagogicas():
    """Testa as funcionalidades pedag√≥gicas b√°sicas"""
    
    print("üéì Testando funcionalidades pedag√≥gicas...")
    
    testes = {}
    
    try:
        from models.pedagogico import listar_turmas_disponiveis
        
        resultado = listar_turmas_disponiveis()
        
        if resultado.get("success"):
            testes["listar_turmas"] = {
                "status": "‚úÖ",
                "total_turmas": len(resultado.get("turmas", [])),
                "erro": None
            }
        else:
            testes["listar_turmas"] = {
                "status": "‚ùå",
                "total_turmas": 0,
                "erro": resultado.get("error", "Erro desconhecido")
            }
    
    except Exception as e:
        testes["listar_turmas"] = {
            "status": "‚ùå",
            "total_turmas": 0,
            "erro": str(e)
        }
    
    # Teste de busca de alunos
    try:
        from models.pedagogico import buscar_alunos_para_dropdown
        
        resultado = buscar_alunos_para_dropdown("test")
        
        if resultado.get("success"):
            testes["buscar_alunos"] = {
                "status": "‚úÖ",
                "funcional": True,
                "erro": None
            }
        else:
            testes["buscar_alunos"] = {
                "status": "‚ö†Ô∏è",
                "funcional": True,
                "erro": "Sem resultados (normal para busca 'test')"
            }
    
    except Exception as e:
        testes["buscar_alunos"] = {
            "status": "‚ùå",
            "funcional": False,
            "erro": str(e)
        }
    
    return testes

def testar_sistema_mensalidades():
    """Testa o sistema de mensalidades"""
    
    print("üìÖ Testando sistema de mensalidades...")
    
    testes = {}
    
    try:
        from gestao_mensalidades import inicializar_sistema_mensalidades
        
        # Inicializar sistema
        inicializar_sistema_mensalidades()
        
        testes["inicializacao"] = {
            "status": "‚úÖ",
            "erro": None
        }
        
    except Exception as e:
        testes["inicializacao"] = {
            "status": "‚ùå",
            "erro": str(e)
        }
        return testes
    
    # Testar listagem por status
    try:
        from gestao_mensalidades import listar_mensalidades_por_status
        
        resultado = listar_mensalidades_por_status("Todos", 5)
        
        if resultado.get("success"):
            testes["listar_por_status"] = {
                "status": "‚úÖ",
                "total_encontradas": len(resultado.get("mensalidades", [])),
                "erro": None
            }
        else:
            testes["listar_por_status"] = {
                "status": "‚ö†Ô∏è",
                "total_encontradas": 0,
                "erro": resultado.get("error", "Sem mensalidades cadastradas")
            }
    
    except Exception as e:
        testes["listar_por_status"] = {
            "status": "‚ùå",
            "total_encontradas": 0,
            "erro": str(e)
        }
    
    # Testar relat√≥rio
    try:
        from gestao_mensalidades import gerar_relatorio_mensalidades_resumido
        
        resultado = gerar_relatorio_mensalidades_resumido({})
        
        if resultado.get("success"):
            testes["relatorio"] = {
                "status": "‚úÖ",
                "funcional": True,
                "erro": None
            }
        else:
            testes["relatorio"] = {
                "status": "‚ö†Ô∏è",
                "funcional": True,
                "erro": "Sem dados para relat√≥rio"
            }
    
    except Exception as e:
        testes["relatorio"] = {
            "status": "‚ùå",
            "funcional": False,
            "erro": str(e)
        }
    
    return testes

def testar_estrutura_arquivos():
    """Testa se todos os arquivos necess√°rios est√£o presentes"""
    
    print("üìÅ Testando estrutura de arquivos...")
    
    arquivos_obrigatorios = [
        "gestao_mensalidades.py",
        "interface_pedagogica_teste.py",
        "interface_processamento_extrato.py",
        "integracao_sistema.py",
        "models/base.py",
        "models/pedagogico.py",
        "README_INTEGRACAO_COMPLETA.md"
    ]
    
    testes = {}
    
    for arquivo in arquivos_obrigatorios:
        if os.path.exists(arquivo):
            # Verificar se n√£o est√° vazio
            try:
                with open(arquivo, 'r', encoding='utf-8') as f:
                    conteudo = f.read().strip()
                    if len(conteudo) > 100:  # Arquivo tem conte√∫do substancial
                        testes[arquivo] = {"status": "‚úÖ", "tamanho": len(conteudo)}
                    else:
                        testes[arquivo] = {"status": "‚ö†Ô∏è", "tamanho": len(conteudo)}
            except Exception as e:
                testes[arquivo] = {"status": "‚ùå", "erro": str(e)}
        else:
            testes[arquivo] = {"status": "‚ùå", "erro": "Arquivo n√£o encontrado"}
    
    return testes

def testar_integracao_completa():
    """Executa teste completo de integra√ß√£o"""
    
    print("üß™ Executando teste completo de integra√ß√£o...")
    
    # Simular fluxo completo se poss√≠vel
    try:
        # 1. Testar busca de aluno
        from models.pedagogico import buscar_alunos_para_dropdown
        resultado_alunos = buscar_alunos_para_dropdown("a")
        
        # 2. Se encontrou alunos, testar mensalidades
        if resultado_alunos.get("success") and resultado_alunos.get("opcoes"):
            from gestao_mensalidades import listar_mensalidades_aluno_completas
            
            primeiro_aluno = resultado_alunos["opcoes"][0]
            resultado_mens = listar_mensalidades_aluno_completas(primeiro_aluno["id"])
            
            return {
                "status": "‚úÖ",
                "alunos_encontrados": len(resultado_alunos["opcoes"]),
                "mensalidades_testadas": resultado_mens.get("success", False),
                "erro": None
            }
        else:
            return {
                "status": "‚ö†Ô∏è",
                "alunos_encontrados": 0,
                "mensalidades_testadas": False,
                "erro": "Nenhum aluno encontrado para teste"
            }
    
    except Exception as e:
        return {
            "status": "‚ùå",
            "alunos_encontrados": 0,
            "mensalidades_testadas": False,
            "erro": str(e)
        }

# ==========================================================
# üéØ FUN√á√ÉO PRINCIPAL
# ==========================================================

def executar_todos_os_testes():
    """Executa todos os testes de integra√ß√£o"""
    
    print("=" * 60)
    print("üß™ INICIANDO TESTE COMPLETO DE INTEGRA√á√ÉO")
    print("=" * 60)
    print()
    
    resultados = {}
    
    # 1. Testar imports
    resultados["imports"] = testar_imports()
    
    # 2. Testar conex√£o
    resultados["database"] = testar_conexao_database()
    
    # 3. Testar funcionalidades pedag√≥gicas
    resultados["pedagogico"] = testar_funcionalidades_pedagogicas()
    
    # 4. Testar sistema de mensalidades
    resultados["mensalidades"] = testar_sistema_mensalidades()
    
    # 5. Testar estrutura de arquivos
    resultados["arquivos"] = testar_estrutura_arquivos()
    
    # 6. Testar integra√ß√£o completa
    resultados["integracao"] = testar_integracao_completa()
    
    return resultados

def gerar_relatorio_final(resultados: Dict):
    """Gera relat√≥rio final dos testes"""
    
    print()
    print("=" * 60)
    print("üìä RELAT√ìRIO FINAL DOS TESTES")
    print("=" * 60)
    print()
    
    # Resumo por categoria
    total_testes = 0
    testes_ok = 0
    testes_warning = 0
    testes_erro = 0
    
    for categoria, dados in resultados.items():
        print(f"üìã {categoria.upper()}:")
        
        if isinstance(dados, dict):
            if "status" in dados:
                # Resultado √∫nico
                total_testes += 1
                status = dados["status"]
                
                if status == "‚úÖ":
                    testes_ok += 1
                elif status == "‚ö†Ô∏è":
                    testes_warning += 1
                else:
                    testes_erro += 1
                
                print(f"   {status} {categoria}")
                if dados.get("erro"):
                    print(f"      Erro: {dados['erro']}")
            else:
                # M√∫ltiplos resultados
                for nome, resultado in dados.items():
                    total_testes += 1
                    
                    if isinstance(resultado, dict) and "status" in resultado:
                        status = resultado["status"]
                        
                        if status == "‚úÖ":
                            testes_ok += 1
                        elif status == "‚ö†Ô∏è":
                            testes_warning += 1
                        else:
                            testes_erro += 1
                        
                        print(f"   {status} {nome}")
                        if resultado.get("erro"):
                            print(f"      Erro: {resultado['erro']}")
        print()
    
    # Estat√≠sticas finais
    print("=" * 60)
    print("üìä ESTAT√çSTICAS FINAIS")
    print("=" * 60)
    print(f"‚úÖ Testes OK: {testes_ok}")
    print(f"‚ö†Ô∏è Testes com Aviso: {testes_warning}")
    print(f"‚ùå Testes com Erro: {testes_erro}")
    print(f"üìã Total de Testes: {total_testes}")
    print()
    
    # Percentual de sucesso
    if total_testes > 0:
        percentual_sucesso = ((testes_ok + testes_warning) / total_testes) * 100
        print(f"üìà Taxa de Sucesso: {percentual_sucesso:.1f}%")
        
        if percentual_sucesso >= 90:
            print("üéâ SISTEMA COMPLETAMENTE INTEGRADO E FUNCIONAL!")
        elif percentual_sucesso >= 70:
            print("‚úÖ Sistema majoritariamente funcional com alguns pontos de aten√ß√£o")
        else:
            print("‚ö†Ô∏è Sistema requer corre√ß√µes antes de uso em produ√ß√£o")
    
    print()
    print("=" * 60)
    print(f"üïê Teste conclu√≠do em: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 60)

# ==========================================================
# üöÄ EXECU√á√ÉO PRINCIPAL
# ==========================================================

if __name__ == "__main__":
    try:
        print(f"üöÄ Iniciando testes em: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print()
        
        # Executar todos os testes
        resultados = executar_todos_os_testes()
        
        # Gerar relat√≥rio final
        gerar_relatorio_final(resultados)
        
    except Exception as e:
        print(f"‚ùå Erro cr√≠tico durante os testes: {str(e)}")
        print()
        print("üîç Traceback completo:")
        traceback.print_exc()
    
    print()
    print("üí° Para executar as interfaces, use:")
    print("   streamlit run interface_pedagogica_teste.py")
    print("   streamlit run interface_processamento_extrato.py")
    print("   streamlit run integracao_sistema.py") 